{% set name = "coincurve" %}
{% set version = "18.0.0" %}
{% set commit = "1dd0675add2da67ad9e6acfc47eed041066f2ea1" %}
{% set sha256 = "124d212b1a663a02a8086d2094e58605d114698f6e562e1212e0ca27a326d84d" %}

package:
  name: {{ name }}-bundle
  version: {{ version }}

source:
  url: https://github.com/ofek/coincurve/archive/{{ commit }}.tar.gz
  sha256: {{ sha256 }}
  patches:
    - update_pyproject.toml.patch
    - update_setup.py.patch
    - update_build.py.patch
    - update_MANIFEST.in.patch
    - update_setup_support.py.patch
    - update_coincurve_deprecated.patch

build:
  number: 0
  missing_dso_whitelist:
    - "*/libc.so.6"

outputs:
  - name: {{ name }}
    script: build-pkg.sh  # [unix]
    script: bld-pkg.bat  # [win]
    build:
      missing_dso_whitelist:
        - "*/libc.so.6"
        - "*/python3.dll"  # [win]
        - "*/VCRUNTIME*.dll"  # [win]
        - "*/ucrtbased.dll"  # [win]
        - "*/KERNEL32.dll"  # [win]
      ignore_run_exports:
        - vc40_runtime
        - ucrt
        - libsecp256k1-static
        - cffi
        - python
      run_exports:
        - {{ pin_subpackage(name, max_pin="x.x") }}
    requirements:
      build:
        - gcc  # [linux]
        - {{ compiler('c') }}
        - {{ pin_compatible('libsecp256k1-static') }}
        - cffi >=1.3.0
        - pkg-config
        - pkgconfig
      host:
        - {{ compiler('c') }}
        - {{ pin_compatible('libsecp256k1-static') }}
        - cffi >=1.3.0
        - pip
        - python
      run:
        - asn1crypto
        - cffi >=1.3.0
        - python
    test:
      imports:
        - {{ name }}
      source_files:
        - tests/
      requires:
        - pip
        - pytest
        - pytest-benchmark
      commands:
        - pip check
        - pytest -v tests

  - name: {{ name }}-shared
    script: build-pkg.sh  # [unix]
    script: bld-pkg.bat  # [win]
    build:
      missing_dso_whitelist:
        - "*/libc.so.6"
        - "*/python3.dll"  # [win]
        - "*/VCRUNTIME*.dll"  # [win]
        - "*/ucrtbased.dll"  # [win]
        - "*/KERNEL32.dll"  # [win]
      ignore_run_exports:
        - libsecp256k1
        - cffi
        - python
        - vc40_runtime
        - ucrt
      run_exports:
        - {{ pin_subpackage(name + "-shared", max_pin="x.x") }}
    requirements:
      build:
        - gcc  # [linux]
        - {{ compiler('c') }}
        - {{ pin_compatible('libsecp256k1') }}
        - cffi >=1.3.0
        - pkg-config
        - pkgconfig
      host:
        - {{ compiler('c') }}
        - {{ pin_compatible('libsecp256k1') }}
        - cffi >=1.3.0
        - pip
        - python
      run:
        - asn1crypto
        - cffi >=1.3.0
        - {{ pin_compatible('libsecp256k1') }}
        - python
    test:
      imports:
        - {{ name }}
      source_files:
        - tests/
      requires:
        - {{ pin_compatible('libsecp256k1') }}
        - pip
        - pytest
        - pytest-benchmark
      commands:
        - pip check
        - pytest -v tests

about:
  home: https://github.com/ofek/coincurve
  summary: Cross-platform Python CFFI bindings for libsecp256k1
  doc_url: https://ofek.dev/coincurve/
  description: |
    This library provides well-tested Python bindings for libsecp256k1, 
    the heavily optimized C library used by Bitcoin Core for operations 
    on the elliptic curve secp256k1.
  license: MIT
  license_file:
    - LICENSE-MIT
    - LICENSE-APACHE

extra:
  recipe-maintainers:
    - ofek
    - MementoRC

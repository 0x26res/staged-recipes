{% set version = "1.7.0" %}

package:
  name: libglvnd-split
  version: {{ version }}

source:
  url: https://gitlab.freedesktop.org/glvnd/libglvnd/-/archive/v{{ version }}/libglvnd-v{{ version }}.tar.bz2
  sha256: d0e1925a3c9aee0143b8c181ac31d5637c8faa081759c277b8e16c7075612c11
  patches:
    - libglvnd_look_for_egl_icd_in_system_location.patch

build:
  skip: true  # [not linux]
  number: 0

requirements:
  build:
    - {{ compiler('c') }}
    - {{ stdlib('c') }}
    - meson
    - pkg-config
    - ninja
  host:
    - xorg-libx11
    - xorg-libxext
    - xorg-xextproto
    - xorg-glproto

outputs:
  - name: libglvnd
    script: install_libglvnd.sh
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ stdlib('c') }}
        - meson
        - pkg-config
        - ninja
      host:
        - xorg-libx11
        - xorg-libxext
        - xorg-xextproto
        - xorg-glproto
    test:
      commands:
        # Shared libraries (change in any SOVER means we need to react on run-export)
        {% set libraries = [
            "EGL.so.1", "GL.so.1", "GLESv1_CM.so.1", "GLESv2.so.2",
            "GLX.so.0", "OpenGL.so.0", "GLdispatch.so.0"
        ] %}
        {% for each_lib in libraries %}
        - test -f $PREFIX/lib/lib{{ each_lib }}
        {% endfor %}

        # Absence of pkg-config metadata (needs to go into -devel output)
        {% for each_lib in libraries %}
        - test ! -f $PREFIX/lib/pkgconfig/{{ each_lib.split(".")[0]|lower }}.pc
        {% endfor %}
        - test ! -f $PREFIX/lib/pkgconfig/libglvnd.pc

        # Absence of headers (need to go into -devel output)
        {% set headers = [
            'EGL/egl.h', 'EGL/eglext.h', 'EGL/eglplatform.h',
            'GL/gl.h', 'GL/glcorearb.h', 'GL/glext.h', 'GL/glx.h', 'GL/glxext.h',
            'GLES/egl.h', 'GLES/gl.h', 'GLES/glext.h', 'GLES/glplatform.h',
            'GLES2/gl2.h', 'GLES2/gl2ext.h', 'GLES2/gl2platform.h',
            'GLES3/gl3.h', 'GLES3/gl31.h', 'GLES3/gl32.h', 'GLES3/gl3ext.h',
            'GLES3/gl3platform.h', 'KHR/khrplatform.h',
            'glvnd/GLdispatchABI.h', 'glvnd/libeglabi.h', 'glvnd/libglxabi.h'
        ] %}
        {% for each_header in headers %}
        - test ! -f $PREFIX/include/{{ each_header }}
        {% endfor %}
  - name: libglvnd-devel
    script: install_libglvnd_devel.sh
    build:
      run_exports:
        - {{ pin_subpackage('libglvnd', max_pin='x') }}
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ stdlib('c') }}
        - meson
        - pkg-config
        - ninja
      host:
        - xorg-libx11
        - xorg-libxext
        - xorg-xextproto
        - xorg-glproto
        - {{ pin_subpackage('libglvnd', exact=True) }}
      run:
        - xorg-xextproto
        - xorg-glproto
        - {{ pin_subpackage('libglvnd', exact=True) }}
    test:
      requires:
        - pkg-config
      commands:
        {% for each_lib in libraries %}
        {% set libname = "libglvnd" if each_lib == "GLdispatch.so.0" else each_lib.split(".")[0]|lower %}
        - pkg-config --print-errors {{ libname }}
        {% endfor %}

        {% for each_header in headers %}
        - test -f $PREFIX/include/{{ each_header }}
        {% endfor %}

about:
  home: https://gitlab.freedesktop.org/glvnd/libglvnd
  license: LicenseRef-libglvnd
  license_file: README.md
  summary: GL Vendor-Neutral Dispatch library

extra:
  feedstock-name: libglvnd
  recipe-maintainers:
    - ehfd
    - traversaro
    - hmaarrfk

From bd3ba0afd59b18f5c838934fc53c55e9609e882a Mon Sep 17 00:00:00 2001
From: brendanf <brendan.furneaux@gmail.com>
Date: Fri, 9 Feb 2024 09:26:09 +0200
Subject: [PATCH 2/2] no static libs in windows

---
 configure.ucrt    | 38 +++++++++++++++++++++-----------------
 configure.win     | 26 ++++++++++++++++++++++++++
 src/Makevars.ucrt |  2 --
 src/Makevars.win  | 15 ---------------
 4 files changed, 47 insertions(+), 34 deletions(-)
 create mode 100644 configure.win
 delete mode 100644 src/Makevars.ucrt
 delete mode 100644 src/Makevars.win

diff --git a/configure.ucrt b/configure.ucrt
index d9eb51d0..97e0bc18 100755
--- a/configure.ucrt
+++ b/configure.ucrt
@@ -1,22 +1,26 @@
-# Library versions
-LIB_VER="f338f50"
-TLS_VER="edb8fec"
+INCLUDE_PATH="${PREFIX}/Library/include"
+LIB_PATH="${PREFIX}/Library/lib"
+echo "running $*"
+MAKEVARS="src/Makevars.win"
+echo "shell INCLUDE: ${INCLUDE}"
+echo "shell LIB: ${LIB}"
 
-tar -xf src/mbedtls-$TLS_VER.tar.xz
-cd mbedtls-$TLS_VER
-echo "Compiling 'libmbedtls' from source ..."
-cmake -G "Unix Makefiles" -DCMAKE_INSTALL_PREFIX=../install .
-cmake --build . --target install
-cd ..
-rm -rf mbedtls-$TLS_VER
+INCLUDE_TR=$(echo "${INCLUDE}" | tr '\\' '/')
+LIB_TR=$(echo "${LIB}" | tr '\\' '/')
 
-tar -xf src/nng-$LIB_VER.tar.xz
-cd nng-$LIB_VER
-echo "Compiling 'libnng' from source ..."
-cmake -G "Unix Makefiles" -DCMAKE_INSTALL_PREFIX=../install .
-cmake --build . --target install
-cd ..
-rm -rf nng-$LIB_VER
+echo "INCLUDE_TR: ${INCLUDE_TR}"
+echo "LIB_TR: ${LIB_TR}"
+
+echo "include path: ${INCLUDE_PATH}"
+echo "library path: ${LIB_PATH}"
+
+PKG_CFLAGS=$(echo "-I\"${INCLUDE_PATH}\"" | tr '\' '/')
+PKG_LIBS=$(echo "-L\"${LIB_PATH}\"" | tr '\' '/')" -lnng -lmbedtls -lmbedx509 -lmbedcrypto -lbcrypt -lws2_32"
+
+echo "PKG_CFLAGS=${PKG_CFLAGS}"
+sed -e "s|@cflags@|$PKG_CFLAGS|" -e "s|@libs@|$PKG_LIBS|" src/Makevars.in >$MAKEVARS
+echo "${MAKEVARS}:"
+cat ${MAKEVARS}
 
 # Success
 exit 0
diff --git a/configure.win b/configure.win
new file mode 100644
index 00000000..97e0bc18
--- /dev/null
+++ b/configure.win
@@ -0,0 +1,26 @@
+INCLUDE_PATH="${PREFIX}/Library/include"
+LIB_PATH="${PREFIX}/Library/lib"
+echo "running $*"
+MAKEVARS="src/Makevars.win"
+echo "shell INCLUDE: ${INCLUDE}"
+echo "shell LIB: ${LIB}"
+
+INCLUDE_TR=$(echo "${INCLUDE}" | tr '\\' '/')
+LIB_TR=$(echo "${LIB}" | tr '\\' '/')
+
+echo "INCLUDE_TR: ${INCLUDE_TR}"
+echo "LIB_TR: ${LIB_TR}"
+
+echo "include path: ${INCLUDE_PATH}"
+echo "library path: ${LIB_PATH}"
+
+PKG_CFLAGS=$(echo "-I\"${INCLUDE_PATH}\"" | tr '\' '/')
+PKG_LIBS=$(echo "-L\"${LIB_PATH}\"" | tr '\' '/')" -lnng -lmbedtls -lmbedx509 -lmbedcrypto -lbcrypt -lws2_32"
+
+echo "PKG_CFLAGS=${PKG_CFLAGS}"
+sed -e "s|@cflags@|$PKG_CFLAGS|" -e "s|@libs@|$PKG_LIBS|" src/Makevars.in >$MAKEVARS
+echo "${MAKEVARS}:"
+cat ${MAKEVARS}
+
+# Success
+exit 0
diff --git a/src/Makevars.ucrt b/src/Makevars.ucrt
deleted file mode 100644
index 11b714f8..00000000
--- a/src/Makevars.ucrt
+++ /dev/null
@@ -1,2 +0,0 @@
-PKG_CFLAGS=-I../install/include -DNNG_STATIC_LIB $(C_VISIBILITY)
-PKG_LIBS=-L../install/lib -lnng -lmbedtls -lmbedx509 -lmbedcrypto -lbcrypt -lws2_32
diff --git a/src/Makevars.win b/src/Makevars.win
deleted file mode 100644
index 29130285..00000000
--- a/src/Makevars.win
+++ /dev/null
@@ -1,15 +0,0 @@
-ifeq "$(WIN)" "64"
-    ARC="x64"
-else
-    ARC="i386"
-endif
-
-PKG_CFLAGS=-I../src-${ARC}/rwinlib-1.7.0_3.5.1/include -DNNG_STATIC_LIB $(C_VISIBILITY)
-PKG_LIBS=-L../src-${ARC}/rwinlib-1.7.0_3.5.1/lib${R_ARCH} -lnng -lmbedtls -lmbedx509 -lmbedcrypto -lbcrypt -lws2_32
-
-all: winlibs
-
-winlibs:
-	curl -sL https://github.com/shikokuchuo/rwinlib/archive/refs/tags/v1.7.0_3.5.1.zip -o nng.zip
-	unzip -q nng.zip
-	rm -f nng.zip
-- 
2.31.1

